{"version":3,"sources":["../lib/db.js"],"names":["savePromisified","findPromisified","findOnePromisified","findOrPromisified","updatePromisified","updateNativePromisified","removeNativePromisified","removePromisified","populatePromisified","mongoObjectId","_load","id","senecaQuery","next","load$","err","data","Error","data$","_getFieldValue","object","field","fieldKey","fieldValue","indexOf","keyRaw","split","length","chain","at","head","value","element","collection","seneca","Promise","resolve","reject","query","Object","assign","make$","save$","dataRaw","where","list$","ret","map","e","undefined","conditionsTasks","or$","cond","runQuery","series","values","listResult","reduce","acc","v","objs","d","r","concat","listMerged","uniqBy","listDataRaw","listData","skip$","splice","limit$","slice","sort$","sort","_sort","condition","a","b","order","keys","k","localeCompare","bundle","fields","originalDoc","updatedDoc","f","fieldToUpdate","set","get","merged","mergeWith","origValue","newValue","isArray","isPlainObject","opFields","native$","db","findAndModify","new","result","remove","remove$","keyString","select","subtree","validValues","filter","toMerge","elements","s","timestamp","Date","getTime","toString","replace","Math","random","toLowerCase"],"mappings":"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","file":"db.js","sourcesContent":["/**\n * @module\n */\nimport async from 'async'\nimport lodash from 'lodash'\nimport lodashFp from 'lodash/fp'\n\nfunction _load (id, senecaQuery, next) {\n  senecaQuery.load$(id, (err, data) => {\n    if (err) return next(err)\n    if (!data) return next(new Error('#notFound'))\n\n    next(null, data.data$())\n  })\n}\n\nfunction _getFieldValue (object, field) {\n  let fieldKey\n  let fieldValue\n\n  // If field name has a period use lodash\n  // for dot notation access\n  if (field.indexOf('.') > 0) {\n    let keyRaw = field.split(/[\\s.]+/)\n\n    fieldKey = keyRaw[keyRaw.length - 1]\n    fieldValue = lodash.chain(object)\n                       .at(field)\n                       .head()\n                       .value()\n  } else {\n    fieldKey = field\n    fieldValue = object[field]\n  }\n\n  return {fieldKey, fieldValue}\n}\n/**\n *\n * @param {Obecjt} element - Element to be stored in MongoDB\n * @param {String} collection - Collection where the element will be stored\n * @returns {Promise}\n */\nexport function savePromisified (element, collection) {\n  let seneca = this\n\n  return new Promise((resolve, reject) => {\n    const query = Object.assign(seneca.make$(collection), element)\n\n    query.save$((err, dataRaw) => {\n      if (err) return reject(err)\n\n      const data = dataRaw.data$()\n      resolve({dataRaw, data})\n    })\n  })\n}\n/**\n *\n * @param {Object} where - Query to be executed\n * @param {String} collection - Collection to be used\n * @returns {Promise} { dataRaw, data }\n */\nexport function findPromisified (where, collection) {\n  let seneca = this\n\n  return new Promise((resolve, reject) => {\n    let query = seneca.make$(collection)\n\n    query.list$(where, (err, ret) => {\n      if (err) return reject(err)\n\n      const data = ret ? ret.map(e => e.data$()) : []\n      const dataRaw = ret || []\n\n      resolve({dataRaw, data})\n    })\n  })\n}\n/**\n *\n * @param {Object} where - Query to be executed\n * @param {String} collection - Collection to be used\n * @returns {Promise} { dataRaw, data }\n */\nexport function findOnePromisified (where, collection) {\n  let seneca = this\n\n  return new Promise((resolve, reject) => {\n    let query = seneca.make$(collection)\n\n    query.load$(where, (err, ret) => {\n      if (err) return reject(err)\n\n      const data = ret ? ret.data$() : undefined\n      const dataRaw = ret || undefined\n\n      resolve({dataRaw, data})\n    })\n  })\n}\n/**\n *\n * @param {Object} where - Query to be executed\n * @param {String} collection - Collection to be used\n * @returns {Promise} { dataRaw, data }\n */\nexport function findOrPromisified (where, collection) {\n  let seneca = this\n\n  return new Promise((resolve, reject) => {\n    let query = seneca.make$(collection)\n\n    const conditionsTasks = where.or$.map((cond) => {\n      function runQuery (next) {\n        query.list$(cond, next)\n      }\n\n      return runQuery\n    })\n\n    async.series(conditionsTasks, (err, values) => {\n      if (err) return reject(err)\n      // Bundle all together the raw and object data\n      // in order to extract them later.\n      const listResult = lodash.reduce(values, (acc, v) => {\n        const objs = v.map(e => Object.assign({}, {d: e.data$()}, {r: e}))\n        return acc.concat(objs)\n      }, [])\n\n      // Merge the list by the id\n      const listMerged = lodash.uniqBy(listResult, 'd.id')\n\n      // Extract the raw and object data\n      const listDataRaw = listMerged.map(r => r.r)\n      const listData = listMerged.map(r => r.d)\n\n      let dataRaw = listDataRaw || {}\n      let data = listData || {}\n\n      if (where.skip$) {\n        dataRaw.splice(0, where.skip$)\n        data.splice(0, where.skip$)\n      }\n\n      if (where.limit$) {\n        dataRaw = dataRaw.slice(0, where.limit$)\n        data = data.slice(0, where.limit$)\n      }\n\n      if (where.sort$) {\n        data.sort(_sort(where.sort$))\n      }\n      resolve({dataRaw, data})\n    })\n  })\n}\n\nfunction _sort (condition) {\n  return (a, b) => {\n    let order = 0\n\n    const keys = Object.keys(condition)\n\n    for (let k of keys) {\n      if (typeof a[k] === 'string') {\n        order = a[k].localeCompare(b[k]) * condition[k]\n      } else {\n        order = a[k] * condition[k] - b[k] * condition[k]\n      }\n\n      if (order !== 0) break\n    }\n\n    return order\n  }\n}\n/**\n *\n * @param dataRaw\n * @param bundle\n * @param fields\n * @returns {Promise}\n */\nexport function updatePromisified (dataRaw, bundle, fields) {\n  return new Promise((resolve, reject) => {\n    const originalDoc = dataRaw.data$()\n\n    const updatedDoc = lodash.reduce(fields, (acc, f) => {\n      const fieldToUpdate = lodashFp.set(f, lodash.get(bundle, f), acc)\n\n      const merged = lodash.mergeWith(originalDoc, fieldToUpdate, (origValue, newValue) => {\n        if (f.indexOf('.') > 0) {\n          return Object.assign({}, origValue, newValue)\n        }\n\n        if (lodash.isArray(origValue) || lodash.isPlainObject(origValue)) {\n          return newValue\n        }\n      })\n\n      return merged\n    }, {})\n\n    dataRaw.data$(updatedDoc)\n           .save$((err, dataRaw) => {\n             if (err) return reject(err)\n\n             const data = dataRaw.data$()\n             resolve({dataRaw, data})\n           })\n  })\n}\n/**\n *\n * @param where\n * @param opFields\n * @param collection\n * @returns {Promise}\n */\nexport function updateNativePromisified (where, opFields, collection) {\n  let seneca = this\n\n  return new Promise((resolve, reject) => {\n    let query = seneca.make$(collection)\n\n    query.native$((err, db) => {\n      if (err) return reject(err)\n\n      db.collection(collection)\n        .findAndModify(where, [['_id', 'asc']], opFields, {new: true}, (err, result) => {\n          if (err) return reject(err)\n          resolve(result.value)\n        })\n    })\n  })\n}\n/**\n *\n * @param {Object} where - Query to be executed\n * @param {String} collection - Collection to be used\n * @returns {Promise} { dataRaw, data }\n */\nexport function removeNativePromisified (where, collection) {\n  let seneca = this\n\n  return new Promise((resolve, reject) => {\n    let query = seneca.make$(collection)\n\n    query.native$((err, db) => {\n      if (err) return reject(err)\n\n      db.collection(collection)\n        .remove(where, (err, result) => {\n          if (err) return reject(err)\n          resolve(result.result)\n        })\n    })\n  })\n}\n/**\n *\n * @param {Object} where - Query to be executed\n * @param {String} collection - Collection to be used\n * @returns {Promise} { dataRaw, data }\n */\nexport function removePromisified (where, collection) {\n  let seneca = this\n\n  return new Promise((resolve, reject) => {\n    let query = seneca.make$(collection)\n\n    query.remove$(where, (err, data) => {\n      if (err) return reject(err)\n      if (!data) return reject(err)\n\n      // It can only remove when value at a time.\n      // So if it wasn't errors it means it deleted one element.\n      resolve(1)\n    })\n  })\n}\n/**\n *\n * @param object\n * @param keyString\n * @param select\n * @param collection\n * @returns {Promise}\n */\nexport function populatePromisified (object, keyString, select, collection) {\n  let seneca = this\n\n  return new Promise((resolve, reject) => {\n    let query = seneca.make$(collection)\n\n    // Lodash 'at' function always returns an array.\n    // That's why head is invoked, it gets the first\n    // element of the array, in fact, the only one.\n    const subtree = lodash.chain(object)\n                          .at(keyString)\n                          .head()\n                          .value()\n\n    async.map(subtree, (id, next) => {\n      return _load(id, query, next)\n    }, (err, values) => {\n      if (err) return reject(err)\n      const validValues = values.filter((v) => v !== undefined)\n\n      let toMerge = validValues\n\n      if (select.length > 0) {\n        toMerge = lodash.reduce(validValues, (result, v) => {\n          let elements = lodash.reduce(select, (acc, s) => {\n            let {fieldKey, fieldValue} = _getFieldValue(v, s)\n            return lodashFp.set(fieldKey, fieldValue, acc)\n          }, {})\n\n          return result.concat(elements)\n        }, [])\n      }\n\n      resolve(lodashFp.set(keyString, toMerge, object))\n    }\n    )\n  })\n}\n/**\n *\n * @returns {string} - Generate a mongoObjectId\n */\nexport function mongoObjectId () {\n  var timestamp = (new Date().getTime() / 1000 | 0).toString(16)\n  return timestamp + 'xxxxxxxxxxxxxxxx'.replace(/[x]/g, () => (Math.random() * 16 | 0).toString(16))\n                                       .toLowerCase()\n}\n"]}